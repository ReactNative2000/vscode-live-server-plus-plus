<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin — Reconcile Payments</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:20px;background:#f7f7f8;color:#111}
    .card{max-width:1100px;margin:0 auto;background:#fff;padding:18px;border-radius:10px;box-shadow:0 6px 20px rgba(10,12,20,.05)}
    h1{margin:0 0 8px;font-size:20px}
    .controls{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px}
    textarea{width:100%;min-height:120px;padding:10px;border-radius:8px;border:1px solid #ddd}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:8px;border-bottom:1px solid #eee;text-align:left}
    th{background:#fafafa}
    .small{font-size:13px;color:#666}
    .btn{background:#2b8a3e;color:#fff;padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
    .btn.ghost{background:#eee;color:#111}
    input[type=text]{padding:6px;border-radius:6px;border:1px solid #ddd}
  </style>
</head>
<body>
  <main class="card">
    <h1>Admin — Reconcile Payments</h1>
    <p class="small">Import form responses (CSV from Google Sheets or JSON), mark rows as paid, add transaction id/amount, and save reconciliation.</p>

    <section>
      <div class="controls">
        <label class="small">Import CSV (export from Google Sheets):</label>
        <input id="fileInput" type="file" accept="text/csv" />
        <button id="clearBtn" class="btn ghost">Clear</button>
      </div>

      <div style="margin-top:8px">
        <label class="small">Or paste JSON array of responses:</label>
        <textarea id="pasteJson" placeholder='[ {"timestamp":"...","fio":"...","topic":"..."}, ... ]'></textarea>
        <div class="controls">
          <button id="parseJson" class="btn">Load JSON</button>
          <button id="downloadTemplate" class="btn ghost">Download CSV Template</button>
        </div>
      </div>
    </section>

    <section id="tableWrap">
      <table id="responsesTable" style="display:none">
        <thead>
          <tr>
            <th>#</th>
            <th>Дата</th>
            <th>ФИО</th>
            <th>Тема</th>
            <th>Оценка</th>
            <th>Paid</th>
            <th>Amount</th>
            <th>Txn ID</th>
            <th>Who</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div style="margin-top:12px;display:flex;gap:10px;align-items:center">
        <button id="saveLocal" class="btn">Save Reconciliation (local)</button>
        <button id="downloadCsv" class="btn">Download CSV</button>
        <input id="pushEndpoint" type="text" placeholder="Optional: Apps Script endpoint to POST reconciliation" style="width:420px" />
        <button id="pushRemote" class="btn ghost">POST to Endpoint</button>
      </div>
    </section>

    <div id="status" class="small" style="margin-top:12px"></div>
  </main>

  <script>
    // Simple CSV parse (header first)
    function parseCSV(text){
      const lines = text.split(/\r?\n/).filter(l=>l.trim());
      if(lines.length===0) return [];
      const headers = lines[0].split(',').map(h=>h.trim());
      return lines.slice(1).map((line)=>{
        const parts = line.split(',');
        const obj = {};
        headers.forEach((h,i)=> obj[h]= (parts[i]||'').trim());
        return obj;
      });
    }

    const STORAGE_KEY = 'reflection_reconciliation_v1';
    let rows = [];

    const fileInput = document.getElementById('fileInput');
    const pasteJson = document.getElementById('pasteJson');
    const parseJson = document.getElementById('parseJson');
    const responsesTable = document.getElementById('responsesTable');
    const tbody = responsesTable.querySelector('tbody');
    const saveLocal = document.getElementById('saveLocal');
    const downloadCsv = document.getElementById('downloadCsv');
    const status = document.getElementById('status');
    const clearBtn = document.getElementById('clearBtn');
    const downloadTemplate = document.getElementById('downloadTemplate');
    const pushEndpoint = document.getElementById('pushEndpoint');
    const pushRemote = document.getElementById('pushRemote');

    function render(){
      tbody.innerHTML='';
      if(!rows.length){ responsesTable.style.display='none'; return; }
      responsesTable.style.display='table';
      rows.forEach((r, idx)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${idx+1}</td>
          <td>${r.timestamp || ''}</td>
          <td>${r.fio || ''}</td>
          <td>${r.topic || ''}</td>
          <td>${r.q3 || ''}</td>
          <td><input data-idx='${idx}' class='paid' type='checkbox' ${r.paid? 'checked':''}></td>
          <td><input data-idx='${idx}' class='amount' type='text' value='${r.amount||''}' /></td>
          <td><input data-idx='${idx}' class='tx' type='text' value='${r.tx||''}' /></td>
          <td><input data-idx='${idx}' class='who' type='text' value='${r.who||''}' /></td>
        `;
        tbody.appendChild(tr);
      });

      // wire inputs
      tbody.querySelectorAll('.paid').forEach(cb => cb.addEventListener('change', e=> { rows[+e.target.dataset.idx].paid = e.target.checked; }));
      tbody.querySelectorAll('.amount').forEach(inp => inp.addEventListener('input', e=> { rows[+e.target.dataset.idx].amount = e.target.value; }));
      tbody.querySelectorAll('.tx').forEach(inp => inp.addEventListener('input', e=> { rows[+e.target.dataset.idx].tx = e.target.value; }));
      tbody.querySelectorAll('.who').forEach(inp => inp.addEventListener('input', e=> { rows[+e.target.dataset.idx].who = e.target.value; }));
    }

    fileInput.addEventListener('change', e=>{
      const f = e.target.files[0];
      if(!f) return;
      const reader = new FileReader();
      reader.onload = function(){
        const data = parseCSV(reader.result);
        rows = data.map(r => ({ timestamp: r.timestamp||r['Timestamp']||r['Дата']||'', fio: r.fio||r['fio']||r['ФИО']||'', topic: r.topic||r['topic']||r['Тема']||'', q3: r.q3||r['q3']||r['Оценка']||'' }));
        render();
      };
      reader.readAsText(f,'utf-8');
    });

    parseJson.addEventListener('click', ()=>{
      try{
        const obj = JSON.parse(pasteJson.value);
        if(!Array.isArray(obj)) throw new Error('Expected JSON array');
        rows = obj.map(r=>({ timestamp: r.timestamp||r.Timestamp||r['Дата']||'', fio: r.fio||r.FIO||r.Fio||'', topic: r.topic||r.topic||r.Topic||'', q3: r.q3||r.q3||'' }));
        render();
      }catch(err){ status.textContent = 'JSON parse error: ' + err.message; setTimeout(()=>status.textContent='',4000); }
    });

    clearBtn.addEventListener('click', ()=>{ rows = []; localStorage.removeItem(STORAGE_KEY); render(); status.textContent='Cleared'; setTimeout(()=>status.textContent='',2000); });

    saveLocal.addEventListener('click', ()=>{
      localStorage.setItem(STORAGE_KEY, JSON.stringify(rows));
      status.textContent = 'Saved to localStorage'; setTimeout(()=>status.textContent='',2000);
    });

    downloadCsv.addEventListener('click', ()=>{
      if(!rows.length) return;
      const headers = ['timestamp','fio','topic','q3','paid','amount','tx','who'];
      const lines = [headers.join(',')];
      rows.forEach(r=>{
        lines.push(headers.map(h=>('"'+((r[h]||'')+'').replace(/"/g,'""')+'"')).join(','));
      });
      const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'reconciliation.csv'; a.click(); URL.revokeObjectURL(url);
    });

    downloadTemplate.addEventListener('click', ()=>{
      const template = 'timestamp,fio,topic,q3\n2025-10-17 12:00,Иванов И.И.,Тема,5\n';
      const blob = new Blob([template], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'responses_template.csv'; a.click(); URL.revokeObjectURL(url);
    });

    pushRemote.addEventListener('click', async ()=>{
      const endpoint = pushEndpoint.value.trim();
      if(!endpoint){ status.textContent='Enter endpoint URL'; return; }
      try{
        const res = await fetch(endpoint, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(rows) });
        if(res.ok) status.textContent='Pushed reconciliation to endpoint'; else status.textContent='Push failed: '+res.status;
      }catch(err){ status.textContent='Push error: '+err.message; }
      setTimeout(()=>status.textContent='',3000);
    });

    // Load saved reconciliations on open
    (function(){
      try{ const saved = JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]'); if(Array.isArray(saved) && saved.length){ rows = saved; render(); status.textContent='Loaded saved reconciliation (local)'; setTimeout(()=>status.textContent='',2000);} }catch(e){}
    })();
  </script>
</body>
</html>
