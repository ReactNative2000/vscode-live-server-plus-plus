<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Admin Reconcile - Reflection Form</title>
    <style>
      body { font-family: system-ui, -apple-system, 'Segoe UI', Roboto, Arial; margin: 20px; }
      table { border-collapse: collapse; width: 100%; margin-top: 12px; }
      th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
      th { background: #f7f7f8; }
      .controls { display:flex; gap: 8px; align-items:center; }
      .small { font-size: 0.9em; color: #444; }
    </style>
  </head>
  <body>
    <h1>Admin Reconcile</h1>
    <p class="small">Upload CSV (export from Sheets) or paste JSON array of responses. Mark rows as paid and download the reconciliation CSV.</p>

    <div class="controls">
      <input id="file" type="file" accept="text/csv,application/json" />
      <button id="pasteJson">Paste JSON</button>
      <button id="downloadCsv">Download CSV</button>
      <label class="small">Search: <input id="filter" placeholder="search name, token, game" /></label>
    </div>

    <div id="tableWrap"></div>

    <script>
      function parseCSV(text) {
        const lines = text.split(/\r?\n/).filter(Boolean)
        const headers = lines.shift().split(/,|\t/).map(h=>h.trim())
        return lines.map(line => {
          const cols = line.split(/,|\t/)
          const obj = {}
          headers.forEach((h,i)=> obj[h]= (cols[i]||'').trim())
          return obj
        })
      }

      function renderTable(items) {
        const wrap = document.getElementById('tableWrap')
        if (!items || !items.length) { wrap.innerHTML = '<p>No rows loaded.</p>'; return }
        const cols = ['timestamp','fio','topic','game','token','whatsOnMind','chatPreview','paid','amount','txid']
        const table = document.createElement('table')
        const thead = document.createElement('thead')
        thead.innerHTML = '<tr>'+cols.map(c=>`<th>${c}</th>`).join('')+'</tr>'
        table.appendChild(thead)
        const tbody = document.createElement('tbody')
        items.forEach((row, idx)=>{
          const tr = document.createElement('tr')
          const chatPreview = Array.isArray(row.chat) ? row.chat.slice(-3).map(x=>x.message||x).join(' | ') : (row.chat||'')
          const cells = [row.timestamp||row.time||'', row.fio||'', row.topic||'', row.game||'', row.token||'', row.whatsOnMind||'', chatPreview, row.paid||'', row.amount||'', row.txid||'']
          tr.innerHTML = '<td>'+cells.join('</td><td>')+'</td>'
          tbody.appendChild(tr)
        })
        table.appendChild(tbody)
        wrap.innerHTML = ''
        wrap.appendChild(table)
      }

      let current = []
      document.getElementById('file').addEventListener('change', async (e)=>{
        const f = e.target.files[0]
        if (!f) return
        const text = await f.text()
        try {
          if (f.type.includes('json')) { current = JSON.parse(text) }
          else { current = parseCSV(text) }
          renderTable(current)
        } catch(err) { alert('Parse error: '+err.message) }
      })

      document.getElementById('pasteJson').addEventListener('click', ()=>{
        const t = prompt('Paste JSON array of responses')
        if (!t) return
        try { current = JSON.parse(t); renderTable(current) } catch(err){ alert('Invalid JSON: '+err.message) }
      })

      document.getElementById('downloadCsv').addEventListener('click', ()=>{
        if (!current.length) return alert('No rows loaded')
        const cols = ['timestamp','fio','topic','game','token','whatsOnMind','chat','paid','amount','txid']
        const csv = [cols.join(',')].concat(current.map(r=>cols.map(c=>`"${(r[c]||'').toString().replace(/"/g,'""')}"`).join(','))).join('\n')
        const blob = new Blob([csv], {type:'text/csv'})
        const url = URL.createObjectURL(blob)
        const a = document.createElement('a')
        a.href = url; a.download = 'reconcile.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url)
      })
    </script>
  </body>
</html>
<!doctype html>

<html lang="ru">

<head>

  <meta charset="utf-8" />

  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <title>Admin — Reconcile Payments</title>

  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:20px;background:#f7f7f8;color:#111}
    .card{max-width:1100px;margin:0 auto;background:#fff;padding:18px;border-radius:10px;box-shadow:0 6px 20px rgba(10,12,20,.05)}
    h1{margin:0 0 8px;font-size:20px}
    .controls{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px}
    textarea{width:100%;min-height:120px;padding:10px;border-radius:8px;border:1px solid #ddd}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:8px;border-bottom:1px solid #eee;text-align:left}
    th{background:#fafafa}
    .small{font-size:13px;color:#666}
    .btn{background:#2b8a3e;color:#fff;padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
    .btn.ghost{background:#eee;color:#111}
    input[type=text]{padding:6px;border-radius:6px;border:1px solid #ddd}
  </style>

</head>

<body>

  <main class="card">

    <h1>Admin — Reconcile Payments</h1>

    <p class="small">Import form responses (CSV from Google Sheets or JSON), mark rows as paid, add transaction id/amount, and save reconciliation.</p>

    <section>

      <div class="controls">

        <label class="small">Import CSV (export from Google Sheets):</label>

        <input id="fileInput" type="file" accept="text/csv" />

        <button id="clearBtn" class="btn ghost">Clear</button>

      </div>

      <div style="margin-top:8px">

        <label class="small">Or paste JSON array of responses:</label>

        <textarea id="pasteJson" placeholder='[ {"timestamp":"...","fio":"...","topic":"..."}, ... ]'></textarea>

        <div class="controls">

          <button id="parseJson" class="btn">Load JSON</button>

          <button id="downloadTemplate" class="btn ghost">Download CSV Template</button>

        </div>

      </div>

    </section>

    <section id="tableWrap">

      <table id="responsesTable" style="display:none">

        <thead>

          <tr>

            <th>#</th>

            <th>Дата</th>

            <th>ФИО</th>

            <th>Тема</th>

            <th>Game</th>

            <th>Token</th>

            <th>What's on mind</th>

            <th>Chat (preview)</th>

            <th>Оценка</th>

            <th>Paid</th>

            <th>Amount</th>

            <th>Txn ID</th>

            <th>Who</th>

          </tr>

        </thead>

        <tbody></tbody>

      </table>

      <div style="margin-top:12px;display:flex;gap:10px;align-items:center;flex-wrap:wrap">

        <button id="saveLocal" class="btn">Save Reconciliation (local)</button>

        <button id="downloadCsv" class="btn">Download CSV</button>

        <input id="pushEndpoint" type="text" placeholder="Optional: Apps Script endpoint to POST reconciliation" style="width:420px" />

        <input id="pushToken" type="text" placeholder="Optional: secret token for endpoint" style="width:220px" />

        <button id="pushRemote" class="btn ghost">POST to Endpoint</button>

      </div>

    </section>

    <div id="status" class="small" style="margin-top:12px"></div>

  </main>

  <script>

    // Simple CSV parse (header first)

    function parseCSV(text){

      const lines = text.split(/\r?\n/).filter(l=>l.trim());

      if(lines.length===0) return [];

      const headers = lines[0].split(',').map(h=>h.trim());

      return lines.slice(1).map((line)=>{

        const parts = line.split(',');

        const obj = {};

        headers.forEach((h,i)=> obj[h]= (parts[i]||'').trim());

        return obj;

      });

    }

    const STORAGE_KEY = 'reflection_reconciliation_v1';

    let rows = [];

    const fileInput = document.getElementById('fileInput');

    const pasteJson = document.getElementById('pasteJson');

    const parseJson = document.getElementById('parseJson');

    const responsesTable = document.getElementById('responsesTable');

    const tbody = responsesTable.querySelector('tbody');

    const saveLocal = document.getElementById('saveLocal');

    const downloadCsv = document.getElementById('downloadCsv');

    const status = document.getElementById('status');

    const clearBtn = document.getElementById('clearBtn');

    const downloadTemplate = document.getElementById('downloadTemplate');

    const pushEndpoint = document.getElementById('pushEndpoint');

    const pushRemote = document.getElementById('pushRemote');

    function render(){

      tbody.innerHTML='';

      if(!rows.length){ responsesTable.style.display='none'; return; }

      responsesTable.style.display='table';

      rows.forEach((r, idx)=>{

        const tr = document.createElement('tr');

        // prepare chat preview

        let chatPreview = '';

        try{

          if(Array.isArray(r.chat)) chatPreview = r.chat.slice(-2).map(c=> (c.text||c)).join(' \u2022 ');

          else if(typeof r.chat === 'string'){

            try{ const c = JSON.parse(r.chat); if(Array.isArray(c)) chatPreview = c.slice(-2).map(x=>x.text||x).join(' \u2022 '); else chatPreview = (r.chat+'').slice(0,80); }catch(e){ chatPreview = (r.chat+'').slice(0,80); }

          }

        }catch(e){ chatPreview = ''; }

        tr.innerHTML = `

          <td>${idx+1}</td>

          <td>${r.timestamp || ''}</td>

          <td>${r.fio || ''}</td>

          <td>${r.topic || ''}</td>

          <td>${r.game || ''}</td>

          <td>${r.token || ''}</td>

          <td>${(r.whatsOnMind||'').replace(/</g,'&lt;').slice(0,120)}</td>

          <td>${(chatPreview||'').replace(/</g,'&lt;')}</td>

          <td>${r.q3 || ''}</td>

          <td><input data-idx='${idx}' class='paid' type='checkbox' ${r.paid? 'checked':''}></td>

          <td><input data-idx='${idx}' class='amount' type='text' value='${r.amount||''}' /></td>

          <td><input data-idx='${idx}' class='tx' type='text' value='${r.tx||''}' /></td>

          <td><input data-idx='${idx}' class='who' type='text' value='${r.who||''}' /></td>

        `;

        tbody.appendChild(tr);

      });

      // wire inputs

      tbody.querySelectorAll('.paid').forEach(cb => cb.addEventListener('change', e=> { rows[+e.target.dataset.idx].paid = e.target.checked; }));

      tbody.querySelectorAll('.amount').forEach(inp => inp.addEventListener('input', e=> { rows[+e.target.dataset.idx].amount = e.target.value; }));

      tbody.querySelectorAll('.tx').forEach(inp => inp.addEventListener('input', e=> { rows[+e.target.dataset.idx].tx = e.target.value; }));

      tbody.querySelectorAll('.who').forEach(inp => inp.addEventListener('input', e=> { rows[+e.target.dataset.idx].who = e.target.value; }));

    }

    fileInput.addEventListener('change', e=>{

      const f = e.target.files[0];

      if(!f) return;

      const reader = new FileReader();

      reader.onload = function(){

        const data = parseCSV(reader.result);

        rows = data.map(r => ({

          timestamp: r.timestamp||r['Timestamp']||r['Дата']||'',

          fio: r.fio||r['fio']||r['ФИО']||'',

          topic: r.topic||r['topic']||r['Тема']||'',

          game: r.game||r['game']||'',

          token: r.token||r['token']||'',

          whatsOnMind: r.whatsOnMind||r['whatsOnMind']||'',

          chat: r.chat||r['chat']||'',

          q3: r.q3||r['q3']||r['Оценка']||''

        }));

        render();

      };

      reader.readAsText(f,'utf-8');

    });

    parseJson.addEventListener('click', ()=>{

      try{

        const obj = JSON.parse(pasteJson.value);

        if(!Array.isArray(obj)) throw new Error('Expected JSON array');

        rows = obj.map(r=>({

          timestamp: r.timestamp||r.Timestamp||r['Дата']||'',

          fio: r.fio||r.FIO||r.Fio||'',

          topic: r.topic||r.topic||r.Topic||'',

          game: r.game||r.Game||'',

          token: r.token||r.Token||'',

          whatsOnMind: r.whatsOnMind||r.whatsOnMind||'',

          chat: r.chat||r.Chat||'',

          q3: r.q3||r.q3||''

        }));

        render();

      }catch(err){ status.textContent = 'JSON parse error: ' + err.message; setTimeout(()=>status.textContent='',4000); }

    });

    clearBtn.addEventListener('click', ()=>{ rows = []; localStorage.removeItem(STORAGE_KEY); render(); status.textContent='Cleared'; setTimeout(()=>status.textContent='',2000); });

    saveLocal.addEventListener('click', ()=>{

      localStorage.setItem(STORAGE_KEY, JSON.stringify(rows));

      status.textContent = 'Saved to localStorage'; setTimeout(()=>status.textContent='',2000);

    });

    downloadCsv.addEventListener('click', ()=>{

      if(!rows.length) return;

      const headers = ['timestamp','fio','topic','game','token','whatsOnMind','chat','q3','paid','amount','tx','who'];

      const lines = [headers.join(',')];

      rows.forEach(r=>{

        lines.push(headers.map(h=>('"'+((r[h]||'')+'').replace(/"/g,'""')+'"')).join(','));

      });

      const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });

      const url = URL.createObjectURL(blob);

      const a = document.createElement('a'); a.href = url; a.download = 'reconciliation.csv'; a.click(); URL.revokeObjectURL(url);

    });

    downloadTemplate.addEventListener('click', ()=>{

      const template = 'timestamp,fio,topic,q3\n2025-10-17 12:00,Иванов И.И.,Тема,5\n';

      const blob = new Blob([template], { type: 'text/csv;charset=utf-8;' });

      const url = URL.createObjectURL(blob);

      const a = document.createElement('a'); a.href = url; a.download = 'responses_template.csv'; a.click(); URL.revokeObjectURL(url);

    });

    pushRemote.addEventListener('click', async ()=>{

      const endpoint = pushEndpoint.value.trim();

      const token = document.getElementById('pushToken').value.trim();

      if(!endpoint){ status.textContent='Enter endpoint URL'; return; }

      try{

        const payload = rows.map(r=> Object.assign({}, r, { _Type: 'reconciliation' }));

        if(token) payload.forEach(p=> p.token = token);

        const res = await fetch(endpoint, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });

        if(res.ok) status.textContent='Pushed reconciliation to endpoint'; else status.textContent='Push failed: '+res.status;

      }catch(err){ status.textContent='Push error: '+err.message; }

      setTimeout(()=>status.textContent='',3000);

    });

    // Load saved reconciliations on open

    (function(){

      try{ const saved = JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]'); if(Array.isArray(saved) && saved.length){ rows = saved; render(); status.textContent='Loaded saved reconciliation (local)'; setTimeout(()=>status.textContent='',2000);} }catch(e){}

    })();

  </script>

</body>

</html>
