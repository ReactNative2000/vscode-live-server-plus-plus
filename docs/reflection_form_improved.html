<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lesson Reflection ‚Äî Form</title>
  <!-- PWA / iOS meta -->
  <link rel="manifest" href="/docs/manifest.webmanifest">
  <meta name="theme-color" content="#2b8a3e">
  <!-- Apple splash / icons -->
  <link rel="apple-touch-icon" href="/docs/icons/icon-180.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/docs/icons/icon-152.png">
  <link rel="apple-touch-icon" sizes="167x167" href="/docs/icons/icon-167.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/docs/icons/icon-180.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <!-- iOS splash screens (recommended to generate for a polished look) -->
  <link rel="apple-touch-startup-image" href="/docs/icons/apple-splash-1125x2436.png" media="(device-width:375px) and (device-height:812px) and (-webkit-device-pixel-ratio:3)">
  <link rel="apple-touch-startup-image" href="/docs/icons/apple-splash-1242x2688.png" media="(device-width:414px) and (device-height:896px) and (-webkit-device-pixel-ratio:3)">
  <link rel="apple-touch-startup-image" href="/docs/icons/apple-splash-828x1792.png" media="(device-width:414px) and (device-height:896px) and (-webkit-device-pixel-ratio:2)">
  <style>
    :root{--bg:#f9f9f9;--card:#fff;--accent:#2b8a3e;--muted:#666}
    body{font-family:Inter, Arial, Helvetica, sans-serif;margin:24px;background:var(--bg);color:#222}
    .card{max-width:760px;margin:18px auto;padding:20px;border-radius:10px;background:var(--card);box-shadow:0 6px 18px rgba(15,23,42,0.06)}
    h1{font-size:20px;margin:0 0 8px}
    p.lead{margin:0 0 18px;color:var(--muted)}
    label{display:block;margin:12px 0 6px;font-weight:600}
    input[type=text],textarea,select{width:100%;padding:10px;border-radius:8px;border:1px solid #d1d5db;font-size:14px}
    textarea{min-height:90px;resize:vertical}
    .checkbox-group label{font-weight:400;display:block;margin:6px 0}
    .controls{display:flex;gap:10px;align-items:center;margin-top:14px}
    button{background:var(--accent);color:#fff;padding:10px 14px;border:none;border-radius:8px;cursor:pointer;font-weight:600}
    button[disabled]{opacity:.6;cursor:not-allowed}
    .msg{padding:10px;border-radius:8px;margin-top:12px}
    .msg.success{background:#ecfdf5;color:#065f46}
    .msg.error{background:#fff1f2;color:#7f1d1d}
    .small{font-size:13px;color:var(--muted)}
  </style>
</head>
<body>
  <main class="card" role="main">
  <h1>Lesson Reflection</h1>
  <p class="lead">Fill in this short reflection ‚Äî responses will be saved to a spreadsheet. If your connection drops, the browser will retry automatically when it's restored.</p>

    <form id="reflectionForm" aria-describedby="formHelp">
      <label for="fio">Student full name</label>
      <input type="text" id="fio" name="fio" autocomplete="name" required>

      <label for="topic">Lesson topic</label>
      <input type="text" id="topic" name="topic" required>

      <label for="q1">1. What part of the lesson was clearest, and what remained unclear? ‚úçÔ∏è</label>
      <textarea id="q1" name="q1" required></textarea>

      <label for="q2">2. At which moment did you get stuck or distracted? üßê</label>
      <textarea id="q2" name="q2" required></textarea>

      <label for="q3">3. Rate the lesson from 1 to 5 ‚≠ê</label>
      <select id="q3" name="q3" required>
        <option value="">--Select--</option>
        <option value="1">1 - didn't understand at all</option>
        <option value="2">2</option>
        <option value="3">3 - okay</option>
        <option value="4">4</option>
        <option value="5">5 - great!</option>
      </select>

      <label for="q4">4. How do you feel leaving the lesson? üòäüòêüò¢ü§©</label>
      <select id="q4" name="q4" required>
        <option value="">--Choose--</option>
        <option value="üòä">üòä Happy</option>
        <option value="üòê">üòê Neutral</option>
        <option value="üò¢">üò¢ Sad</option>
        <option value="ü§©">ü§© Excited</option>
      </select>

      <label>5. What could be improved in the lesson? (multiple)</label>
      <div class="checkbox-group" role="group" aria-label="–ß—Ç–æ –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å">
  <label><input type="checkbox" name="q5" value="More examples"> More examples</label>
  <label><input type="checkbox" name="q5" value="More interaction"> More interaction</label>
  <label><input type="checkbox" name="q5" value="Slower pace"> Slower pace</label>
  <label><input type="checkbox" name="q5" value="Faster pace"> Faster pace</label>
  <label><input type="checkbox" name="q5" value="More images/videos"> More images/videos</label>
      </div>

      <div class="controls">
        <button id="submitBtn" type="submit">Send</button>
        <div class="small" id="statusText">&nbsp;</div>
      </div>

      <section aria-label="Payment" style="margin-top:14px;border-top:1px solid #eee;padding-top:12px;">
  <label style="font-weight:600;">Payment (optional)</label>
  <p class="small">If you'd like to support the author, you can pay via Cash App:</p>
        <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
          <a id="cashLink" class="small" href="#" target="_blank" rel="noopener">Pay $brandon314314 on Cash App</a>
          <div id="qrWrap" style="width:110px;height:110px;background:#fff;padding:6px;border-radius:8px;display:flex;align-items:center;justify-content:center;border:1px solid #eee">
            <img id="cashQr" alt="Cash App QR" style="max-width:100%;max-height:100%" src="" />
          </div>
        </div>
        <p class="small">After payment, please mark the payment in your records ‚Äî form submission is independent and will be sent regardless of payment.</p>
      </section>

      <div id="feedback" aria-live="polite"></div>
      <p id="formHelp" class="small">Responses are saved via Google Apps Script. If there's a problem, try again later ‚Äî the browser will retry automatically.</p>
    </form>
  </main>

  <script>
    (function(){
      const ENDPOINT = 'https://script.google.com/macros/s/AKfycbwELGti1O-UzG5fhGf0IYJY-wZ1wzYmxGO4aGgi9WpzwO0Wr_SjGIc-68MHY72kUmJ7rA/exec';
      const form = document.getElementById('reflectionForm');
      const submitBtn = document.getElementById('submitBtn');
      const feedback = document.getElementById('feedback');
      const statusText = document.getElementById('statusText');
      const STORAGE_KEY = 'reflection_offline_queue_v1';

      // utility: show message
      function showMessage(type, text){
        feedback.innerHTML = '';
        const div = document.createElement('div');
        div.className = 'msg ' + (type === 'ok' ? 'success' : 'error');
        div.textContent = text;
        feedback.appendChild(div);
      }

      // read queued items
      function loadQueue(){
        try{
          return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
        }catch(e){
          return [];
        }
      }
      function saveQueue(q){ localStorage.setItem(STORAGE_KEY, JSON.stringify(q)); }

      // add to offline queue
      function enqueue(data){
        const q = loadQueue(); q.push({data, ts:Date.now()}); saveQueue(q);
        updateStatus();
      }

      function updateStatus(){
        const q = loadQueue();
        if(q.length) statusText.textContent = `–í –æ—á–µ—Ä–µ–¥–∏ –Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫—É: ${q.length}`;
  else statusText.textContent = navigator.onLine ? 'Ready' : 'Offline ‚Äî responses will be sent when connection returns';
      }

      // helper: timeout for fetch
      function fetchWithTimeout(url, opts = {}, timeout = 8000){
        return new Promise((resolve, reject) => {
          const timer = setTimeout(() => reject(new Error('timeout')), timeout);
          fetch(url, opts).then(res => { clearTimeout(timer); resolve(res); }).catch(err => { clearTimeout(timer); reject(err); });
        });
      }

      async function sendFormEncoded(payload){
        const params = new URLSearchParams();
        if(payload.fio) params.append('fio', payload.fio);
        if(payload.topic) params.append('topic', payload.topic);
        if(payload.q1) params.append('q1', payload.q1);
        if(payload.q2) params.append('q2', payload.q2);
        if(payload.q3) params.append('q3', payload.q3);
        if(payload.q4) params.append('q4', payload.q4);
        if(Array.isArray(payload.q5)){
          payload.q5.forEach(v => params.append('q5', v));
        }

        return fetchWithTimeout(ENDPOINT, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8' },
          body: params.toString()
        }, 10000);
      }

      async function sendPayload(payload){
        // Try JSON first (modern servers). If server rejects or returns non-OK,
        // attempt form-encoded fallback which is commonly accepted by Google Apps Script.
        try{
          const res = await fetchWithTimeout(ENDPOINT, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          }, 10000);

          if(res.ok) return res;

          // non-OK ‚Äî try form-encoded as fallback
          const res2 = await sendFormEncoded(payload);
          return res2;
        }catch(err){
          // network/timeout ‚Äî rethrow to be handled by caller
          throw err;
        }
      }

      async function flushQueue(){
        const q = loadQueue();
        if(!q.length) return;
        // send items in FIFO order
        while(q.length){
          const item = q[0];
          try{
            await sendPayload(item.data);
            q.shift();
            saveQueue(q);
            updateStatus();
          }catch(err){
            // stop on first failure ‚Äî will retry later
            updateStatus();
            return;
          }
        }
      }

      // try flushing when online
      window.addEventListener('online', () => { updateStatus(); flushQueue().catch(()=>{}); });
      window.addEventListener('offline', () => updateStatus());

      form.addEventListener('submit', async function(e){
        e.preventDefault();
        feedback.innerHTML = '';
        submitBtn.disabled = true;
        submitBtn.textContent = '–û—Ç–ø—Ä–∞–≤–ª—è–µ–º...';

        // collect data
        const data = {
          fio: document.getElementById('fio').value.trim(),
          topic: document.getElementById('topic').value.trim(),
          q1: document.getElementById('q1').value.trim(),
          q2: document.getElementById('q2').value.trim(),
          q3: document.getElementById('q3').value,
          q4: document.getElementById('q4').value,
          q5: Array.from(document.querySelectorAll('input[name="q5"]:checked')).map(el=>el.value)
        };

        // basic validation
        if(!data.fio || !data.topic || !data.q1 || !data.q2 || !data.q3 || !data.q4){
          showMessage('err', 'Please fill in all required fields.');
          submitBtn.disabled = false; submitBtn.textContent = 'Send';
          return;
        }

        // optimistic try to send
        try{
          if(!navigator.onLine){
            enqueue(data);
            showMessage('ok', 'Offline ‚Äî your response has been saved and will be sent when connection is restored.');
            form.reset();
            updateStatus();
            submitBtn.disabled = false; submitBtn.textContent = 'Send';
            return;
          }

          const res = await sendPayload(data);
          if(res.ok){
            showMessage('ok', '‚úÖ Response saved to the spreadsheet! Thank you.');
            form.reset();
            // after success try to flush any queued items
            flushQueue().catch(()=>{});
          }else{
            // server returned error ‚Äî enqueue
            enqueue(data);
            showMessage('err', 'Server returned an error ‚Äî response queued and will be retried later.');
          }
        }catch(err){
          // network or timeout
          enqueue(data);
          showMessage('err', 'Network or server error ‚Äî response queued for retry.');
        }

  submitBtn.disabled = false; submitBtn.textContent = 'Send';
        updateStatus();
      });

      // initial status and attempt to flush on load
      updateStatus();
      if(navigator.onLine) flushQueue().catch(()=>{});

      // Payment QR/link generation
      try{
        const cashtag = '$brandon314314';
        // Cash App deep link (works on mobile) and web link
        const cashUrl = `https://cash.app/$${encodeURIComponent(cashtag.replace('$',''))}`;
        const qrData = encodeURIComponent(cashUrl);
        const qrSrc = `https://chart.googleapis.com/chart?cht=qr&chs=200x200&chl=${qrData}&chld=L|1`;
        const cashLinkEl = document.getElementById('cashLink');
        const cashQrEl = document.getElementById('cashQr');
        if(cashLinkEl){ cashLinkEl.href = cashUrl; cashLinkEl.textContent = `Pay ${cashtag} on Cash App`; }
        if(cashQrEl) cashQrEl.src = qrSrc;
      }catch(e){ /* ignore */ }
    })();
  </script>
  <script>
    // Register service worker for offline capability and PWA install
    if('serviceWorker' in navigator){
      navigator.serviceWorker.register('/docs/sw.js').then(reg => {
        // console.log('SW registered', reg);
      }).catch(err => {
        // console.warn('SW registration failed', err);
      });
    }
    // iOS users: show a tiny hint when in standalone mode
    (function(){
      if(window.navigator.standalone === false){
        // Not in standalone - you can prompt users to Add to Home Screen manually if you want
      }
    })();
  </script>
</body>
</html>
