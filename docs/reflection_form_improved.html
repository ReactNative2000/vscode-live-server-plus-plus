<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–†–µ—Ñ–ª–µ–∫—Å–∏—è —É—Ä–æ–∫–∞ ‚Äî —Ñ–æ—Ä–º–∞</title>
  <style>
    :root{--bg:#f9f9f9;--card:#fff;--accent:#2b8a3e;--muted:#666}
    body{font-family:Inter, Arial, Helvetica, sans-serif;margin:24px;background:var(--bg);color:#222}
    .card{max-width:760px;margin:18px auto;padding:20px;border-radius:10px;background:var(--card);box-shadow:0 6px 18px rgba(15,23,42,0.06)}
    h1{font-size:20px;margin:0 0 8px}
    p.lead{margin:0 0 18px;color:var(--muted)}
    label{display:block;margin:12px 0 6px;font-weight:600}
    input[type=text],textarea,select{width:100%;padding:10px;border-radius:8px;border:1px solid #d1d5db;font-size:14px}
    textarea{min-height:90px;resize:vertical}
    .checkbox-group label{font-weight:400;display:block;margin:6px 0}
    .controls{display:flex;gap:10px;align-items:center;margin-top:14px}
    button{background:var(--accent);color:#fff;padding:10px 14px;border:none;border-radius:8px;cursor:pointer;font-weight:600}
    button[disabled]{opacity:.6;cursor:not-allowed}
    .msg{padding:10px;border-radius:8px;margin-top:12px}
    .msg.success{background:#ecfdf5;color:#065f46}
    .msg.error{background:#fff1f2;color:#7f1d1d}
    .small{font-size:13px;color:var(--muted)}
  </style>
</head>
<body>
  <main class="card" role="main">
    <h1>–†–µ—Ñ–ª–µ–∫—Å–∏—è –ø–æ —É—Ä–æ–∫—É</h1>
    <p class="lead">–ó–∞–ø–æ–ª–Ω–∏ –∫–æ—Ä–æ—Ç–∫—É—é —Ñ–æ—Ä–º—É ‚Äî –æ—Ç–≤–µ—Ç—ã —Å–æ—Ö—Ä–∞–Ω—è—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü—É. –ï—Å–ª–∏ –ø—Ä–æ–ø–∞–¥—ë—Ç —Å–≤—è–∑—å, –º—ã –ø–æ–ø—Ä–æ–±—É–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –∫–æ–≥–¥–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è.</p>

    <form id="reflectionForm" aria-describedby="formHelp">
      <label for="fio">–§–ò–û —É—á–µ–Ω–∏–∫–∞</label>
      <input type="text" id="fio" name="fio" autocomplete="name" required>

      <label for="topic">–¢–µ–º–∞ —É—Ä–æ–∫–∞</label>
      <input type="text" id="topic" name="topic" required>

      <label for="q1">1. –ß—Ç–æ –Ω–∞ —É—Ä–æ–∫–µ –±—ã–ª–æ —Å–∞–º—ã–º –ø–æ–Ω—è—Ç–Ω—ã–º, –∞ —á—Ç–æ –æ—Å—Ç–∞–ª–æ—Å—å —Ç—É–º–∞–Ω–Ω—ã–º? ‚úçÔ∏è</label>
      <textarea id="q1" name="q1" required></textarea>

      <label for="q2">2. –ù–∞ –∫–∞–∫–æ–º –º–æ–º–µ–Ω—Ç–µ —É—Ä–æ–∫–∞ —Ç—ã –∑–∞–ª–∏–ø? üßê</label>
      <textarea id="q2" name="q2" required></textarea>

      <label for="q3">3. –û—Ü–µ–Ω–∏ —É—Ä–æ–∫ –ø–æ —à–∫–∞–ª–µ –æ—Ç 1 –¥–æ 5 ‚≠ê</label>
      <select id="q3" name="q3" required>
        <option value="">--–í—ã–±–µ—Ä–∏--</option>
        <option value="1">1 - —Å–æ–≤—Å–µ–º –Ω–µ –ø–æ–Ω—è–ª</option>
        <option value="2">2</option>
        <option value="3">3 - –Ω–æ—Ä–º–∞–ª—å–Ω–æ</option>
        <option value="4">4</option>
        <option value="5">5 - —Å—É–ø–µ—Ä!</option>
      </select>

      <label for="q4">4. –° –∫–∞–∫–∏–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ–º —É—Ö–æ–¥–∏—à—å? üòäüòêüò¢ü§©</label>
      <select id="q4" name="q4" required>
        <option value="">--–í—ã–±–µ—Ä–∏ —Å–º–∞–π–ª–∏–∫--</option>
        <option value="üòä">üòä –†–∞–¥–æ—Å—Ç—å</option>
        <option value="üòê">üòê –°–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ</option>
        <option value="üò¢">üò¢ –ì—Ä—É—Å—Ç—å</option>
        <option value="ü§©">ü§© –í–æ—Å—Ç–æ—Ä–≥</option>
      </select>

      <label>5. –ß—Ç–æ –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å –≤ —É—Ä–æ–∫–µ? (–Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤)</label>
      <div class="checkbox-group" role="group" aria-label="–ß—Ç–æ –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å">
        <label><input type="checkbox" name="q5" value="–ë–æ–ª—å—à–µ –ø—Ä–∏–º–µ—Ä–æ–≤"> –ë–æ–ª—å—à–µ –ø—Ä–∏–º–µ—Ä–æ–≤</label>
        <label><input type="checkbox" name="q5" value="–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤"> –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤</label>
        <label><input type="checkbox" name="q5" value="–¢–µ–º–ø –ø–æ–º–µ–¥–ª–µ–Ω–Ω–µ–µ"> –¢–µ–º–ø –ø–æ–º–µ–¥–ª–µ–Ω–Ω–µ–µ</label>
        <label><input type="checkbox" name="q5" value="–¢–µ–º–ø –ø–æ–±—ã—Å—Ç—Ä–µ–µ"> –¢–µ–º–ø –ø–æ–±—ã—Å—Ç—Ä–µ–µ</label>
        <label><input type="checkbox" name="q5" value="–ë–æ–ª—å—à–µ –∫–∞—Ä—Ç–∏–Ω–æ–∫/–≤–∏–¥–µ–æ"> –ë–æ–ª—å—à–µ –∫–∞—Ä—Ç–∏–Ω–æ–∫/–≤–∏–¥–µ–æ</label>
      </div>

      <div class="controls">
        <button id="submitBtn" type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        <div class="small" id="statusText">&nbsp;</div>
      </div>

      <section aria-label="Payment" style="margin-top:14px;border-top:1px solid #eee;padding-top:12px;">
        <label style="font-weight:600;">–û–ø–ª–∞—Ç–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
        <p class="small">–ï—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å –∞–≤—Ç–æ—Ä–∞, –º–æ–∂–Ω–æ –æ–ø–ª–∞—Ç–∏—Ç—å —á–µ—Ä–µ–∑ Cash App:</p>
        <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
          <a id="cashLink" class="small" href="#" target="_blank" rel="noopener">Pay $brandon314314 on Cash App</a>
          <div id="qrWrap" style="width:110px;height:110px;background:#fff;padding:6px;border-radius:8px;display:flex;align-items:center;justify-content:center;border:1px solid #eee">
            <img id="cashQr" alt="Cash App QR" style="max-width:100%;max-height:100%" src="" />
          </div>
        </div>
        <p class="small">–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–º–µ—Ç—å—Ç–µ –ø–ª–∞—Ç—ë–∂ –≤ –≤–∞—à–µ–π —Å–∏—Å—Ç–µ–º–µ ‚Äî –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã –Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –ø–ª–∞—Ç–µ–∂–∞ –∏ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ.</p>
      </section>

      <div id="feedback" aria-live="polite"></div>
      <p id="formHelp" class="small">–û—Ç–≤–µ—Ç—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è —á–µ—Ä–µ–∑ Google Apps Script. –í —Å–ª—É—á–∞–µ –ø—Ä–æ–±–ª–µ–º –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ ‚Äî –±—Ä–∞—É–∑–µ—Ä –ø–æ–ø—ã—Ç–∞–µ—Ç—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</p>
    </form>
  </main>

  <script>
    (function(){
      const ENDPOINT = 'https://script.google.com/macros/s/AKfycbwELGti1O-UzG5fhGf0IYJY-wZ1wzYmxGO4aGgi9WpzwO0Wr_SjGIc-68MHY72kUmJ7rA/exec';
      const form = document.getElementById('reflectionForm');
      const submitBtn = document.getElementById('submitBtn');
      const feedback = document.getElementById('feedback');
      const statusText = document.getElementById('statusText');
      const STORAGE_KEY = 'reflection_offline_queue_v1';

      // utility: show message
      function showMessage(type, text){
        feedback.innerHTML = '';
        const div = document.createElement('div');
        div.className = 'msg ' + (type === 'ok' ? 'success' : 'error');
        div.textContent = text;
        feedback.appendChild(div);
      }

      // read queued items
      function loadQueue(){
        try{
          return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
        }catch(e){
          return [];
        }
      }
      function saveQueue(q){ localStorage.setItem(STORAGE_KEY, JSON.stringify(q)); }

      // add to offline queue
      function enqueue(data){
        const q = loadQueue(); q.push({data, ts:Date.now()}); saveQueue(q);
        updateStatus();
      }

      function updateStatus(){
        const q = loadQueue();
        if(q.length) statusText.textContent = `–í –æ—á–µ—Ä–µ–¥–∏ –Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫—É: ${q.length}`;
        else statusText.textContent = navigator.onLine ? '–ì–æ—Ç–æ–≤–æ' : '–û—Ñ—Ñ–ª–∞–π–Ω ‚Äî –æ—Ç–≤–µ—Ç—ã –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏';
      }

      // helper: timeout for fetch
      function fetchWithTimeout(url, opts = {}, timeout = 8000){
        return new Promise((resolve, reject) => {
          const timer = setTimeout(() => reject(new Error('timeout')), timeout);
          fetch(url, opts).then(res => { clearTimeout(timer); resolve(res); }).catch(err => { clearTimeout(timer); reject(err); });
        });
      }

      async function sendFormEncoded(payload){
        const params = new URLSearchParams();
        if(payload.fio) params.append('fio', payload.fio);
        if(payload.topic) params.append('topic', payload.topic);
        if(payload.q1) params.append('q1', payload.q1);
        if(payload.q2) params.append('q2', payload.q2);
        if(payload.q3) params.append('q3', payload.q3);
        if(payload.q4) params.append('q4', payload.q4);
        if(Array.isArray(payload.q5)){
          payload.q5.forEach(v => params.append('q5', v));
        }

        return fetchWithTimeout(ENDPOINT, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8' },
          body: params.toString()
        }, 10000);
      }

      async function sendPayload(payload){
        // Try JSON first (modern servers). If server rejects or returns non-OK,
        // attempt form-encoded fallback which is commonly accepted by Google Apps Script.
        try{
          const res = await fetchWithTimeout(ENDPOINT, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          }, 10000);

          if(res.ok) return res;

          // non-OK ‚Äî try form-encoded as fallback
          const res2 = await sendFormEncoded(payload);
          return res2;
        }catch(err){
          // network/timeout ‚Äî rethrow to be handled by caller
          throw err;
        }
      }

      async function flushQueue(){
        const q = loadQueue();
        if(!q.length) return;
        // send items in FIFO order
        while(q.length){
          const item = q[0];
          try{
            await sendPayload(item.data);
            q.shift();
            saveQueue(q);
            updateStatus();
          }catch(err){
            // stop on first failure ‚Äî will retry later
            updateStatus();
            return;
          }
        }
      }

      // try flushing when online
      window.addEventListener('online', () => { updateStatus(); flushQueue().catch(()=>{}); });
      window.addEventListener('offline', () => updateStatus());

      form.addEventListener('submit', async function(e){
        e.preventDefault();
        feedback.innerHTML = '';
        submitBtn.disabled = true;
        submitBtn.textContent = '–û—Ç–ø—Ä–∞–≤–ª—è–µ–º...';

        // collect data
        const data = {
          fio: document.getElementById('fio').value.trim(),
          topic: document.getElementById('topic').value.trim(),
          q1: document.getElementById('q1').value.trim(),
          q2: document.getElementById('q2').value.trim(),
          q3: document.getElementById('q3').value,
          q4: document.getElementById('q4').value,
          q5: Array.from(document.querySelectorAll('input[name="q5"]:checked')).map(el=>el.value)
        };

        // basic validation
        if(!data.fio || !data.topic || !data.q1 || !data.q2 || !data.q3 || !data.q4){
          showMessage('err', '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è.');
          submitBtn.disabled = false; submitBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å';
          return;
        }

        // optimistic try to send
        try{
          if(!navigator.onLine){
            enqueue(data);
            showMessage('ok', '–°–µ—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚Äî –æ—Ç–≤–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω –∏ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏.');
            form.reset();
            updateStatus();
            submitBtn.disabled = false; submitBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å';
            return;
          }

          const res = await sendPayload(data);
          if(res.ok){
            showMessage('ok', '‚úÖ –û—Ç–≤–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ —Ç–∞–±–ª–∏—Ü–µ! –°–ø–∞—Å–∏–±–æ.');
            form.reset();
            // after success try to flush any queued items
            flushQueue().catch(()=>{});
          }else{
            // server returned error ‚Äî enqueue
            enqueue(data);
            showMessage('err', '–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É ‚Äî –æ—Ç–≤–µ—Ç –ø–æ–º–µ—â—ë–Ω –≤ –æ—á–µ—Ä–µ–¥—å –∏ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø–æ–∑–∂–µ.');
          }
        }catch(err){
          // network or timeout
          enqueue(data);
          showMessage('err', '–ü—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ç—å—é –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä–æ–º ‚Äî –æ—Ç–≤–µ—Ç –ø–æ–º–µ—â—ë–Ω –≤ –æ—á–µ—Ä–µ–¥—å.');
        }

        submitBtn.disabled = false; submitBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å';
        updateStatus();
      });

      // initial status and attempt to flush on load
      updateStatus();
      if(navigator.onLine) flushQueue().catch(()=>{});
    })();
  </script>
</body>
</html>
