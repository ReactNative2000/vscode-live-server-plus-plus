<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–†–µ—Ñ–ª–µ–∫—Å–∏—è —É—Ä–æ–∫–∞</title>
  <style>
    :root{--bg:#f9f9f9;--card:#fff;--muted:#666}
    body {
      font-family: Arial, sans-serif;
      margin: 30px;
      background: var(--bg);
      color: #222;
    }
    .card{
      background: var(--card);
      padding: 20px 22px;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(20,20,20,0.06);
      max-width: 760px;
      margin: 0 auto;
    }
    h2 {
      color: #333;
      margin-top: 0;
    }
    label {
      display: block;
      margin: 12px 0 6px;
      font-weight: bold;
    }
    textarea, select, input[type="text"] {
      width: 100%;
      padding: 10px 12px;
      margin-bottom: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 15px;
      box-sizing: border-box;
    }
    .checkbox-group label {
      font-weight: normal;
      display: block;
      margin-bottom: 6px;
    }
    .controls{
      display:flex;
      gap:12px;
      align-items:center;
      margin-top:14px;
    }
    button {
      background: #4CAF50;
      color: white;
      padding: 12px 18px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
    }
    button[disabled]{
      opacity:0.6;
      cursor: not-allowed;
    }
    .status{
      font-size:14px;
      color: var(--muted);
    }
    .hint{font-size:13px;color:#666;margin-top:8px}
    .small{font-size:13px;color:#666}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    input:focus, textarea:focus, select:focus{outline:2px solid #9be6a0}
  </style>
</head>
<body>
  <div class="card">
    <h2>–†–µ—Ñ–ª–µ–∫—Å–∏—è –ø–æ —É—Ä–æ–∫—É</h2>
    <form id="reflectionForm" aria-describedby="formHint" novalidate>
      <p id="formHint" class="hint">–ü–æ–ª—è —Å * –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã. –û—Ç–≤–µ—Ç—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –≤ —á–µ—Ä–Ω–æ–≤–∏–∫ –Ω–∞ —Å–ª—É—á–∞–π –æ—à–∏–±–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏.</p>

      <label for="fio">–§–ò–û —É—á–µ–Ω–∏–∫–∞: *</label>
      <input type="text" id="fio" name="fio" required aria-required="true">

      <label for="topic">–¢–µ–º–∞ —É—Ä–æ–∫–∞: *</label>
      <input type="text" id="topic" name="topic" required aria-required="true">

      <label for="q1">1. –ß—Ç–æ –Ω–∞ —É—Ä–æ–∫–µ –±—ã–ª–æ —Å–∞–º—ã–º –ø–æ–Ω—è—Ç–Ω—ã–º, –∞ —á—Ç–æ –æ—Å—Ç–∞–ª–æ—Å—å —Ç—É–º–∞–Ω–Ω—ã–º? ‚úçÔ∏è *</label>
      <textarea id="q1" name="q1" rows="4" required aria-required="true"></textarea>

      <label for="q2">2. –ù–∞ –∫–∞–∫–æ–º –º–æ–º–µ–Ω—Ç–µ —É—Ä–æ–∫–∞ —Ç—ã –∑–∞–ª–∏–ø? üßê *</label>
      <textarea id="q2" name="q2" rows="3" required aria-required="true"></textarea>

      <label for="q3">3. –û—Ü–µ–Ω–∏ —É—Ä–æ–∫ –ø–æ —à–∫–∞–ª–µ –æ—Ç 1 –¥–æ 5 ‚≠ê *</label>
      <select id="q3" name="q3" required aria-required="true">
        <option value="">--–í—ã–±–µ—Ä–∏--</option>
        <option value="1">1 - —Å–æ–≤—Å–µ–º –Ω–µ –ø–æ–Ω—è–ª</option>
        <option value="2">2</option>
        <option value="3">3 - –Ω–æ—Ä–º–∞–ª—å–Ω–æ</option>
        <option value="4">4</option>
        <option value="5">5 - —Å—É–ø–µ—Ä!</option>
      </select>

      <label for="q4">4. –° –∫–∞–∫–∏–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ–º —É—Ö–æ–¥–∏—à—å? üòäüòêüò¢ü§© *</label>
      <select id="q4" name="q4" required aria-required="true">
        <option value="">--–í—ã–±–µ—Ä–∏ —Å–º–∞–π–ª–∏–∫--</option>
        <option value="üòä">üòä –†–∞–¥–æ—Å—Ç—å</option>
        <option value="üòê">üòê –°–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ</option>
        <option value="üò¢">üò¢ –ì—Ä—É—Å—Ç—å</option>
        <option value="ü§©">ü§© –í–æ—Å—Ç–æ—Ä–≥</option>
      </select>

      <label>5. –ß—Ç–æ –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å –≤ —É—Ä–æ–∫–µ? (–º–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤)</label>
      <div class="checkbox-group" role="group" aria-label="–ß—Ç–æ –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å">
        <label><input type="checkbox" name="q5" value="–ë–æ–ª—å—à–µ –ø—Ä–∏–º–µ—Ä–æ–≤"> –ë–æ–ª—å—à–µ –ø—Ä–∏–º–µ—Ä–æ–≤</label>
        <label><input type="checkbox" name="q5" value="–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤"> –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤</label>
        <label><input type="checkbox" name="q5" value="–¢–µ–º–ø –ø–æ–º–µ–¥–ª–µ–Ω–Ω–µ–µ"> –¢–µ–º–ø –ø–æ–º–µ–¥–ª–µ–Ω–Ω–µ–µ</label>
        <label><input type="checkbox" name="q5" value="–¢–µ–º–ø –ø–æ–±—ã—Å—Ç—Ä–µ–µ"> –¢–µ–º–ø –ø–æ–±—ã—Å—Ç—Ä–µ–µ</label>
        <label><input type="checkbox" name="q5" value="–ë–æ–ª—å—à–µ –∫–∞—Ä—Ç–∏–Ω–æ–∫/–≤–∏–¥–µ–æ"> –ë–æ–ª—å—à–µ –∫–∞—Ä—Ç–∏–Ω–æ–∫/–≤–∏–¥–µ–æ</label>
      </div>

      <div class="controls">
        <button id="submitBtn" type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        <div class="status" id="status" role="status" aria-live="polite"></div>
      </div>

      <p class="small" id="draftInfo"></p>
    </form>
  </div>

  <script>
    (function(){
      const FORM_KEY = 'reflectionDraft_v1';
      const url = 'https://script.google.com/macros/s/AKfycbwELGti1O-UzG5fhGf0IYJY-wZ1wzYmxGO4aGgi9WpzwO0Wr_SjGIc-68MHY72kUmJ7rA/exec';
      const form = document.getElementById('reflectionForm');
      const statusEl = document.getElementById('status');
      const btn = document.getElementById('submitBtn');
      const draftInfo = document.getElementById('draftInfo');

      // Restore draft if exists
      try{
        const raw = localStorage.getItem(FORM_KEY);
        if(raw){
          const draft = JSON.parse(raw);
          if(confirm('–ù–∞–π–¥–µ–Ω —á–µ—Ä–Ω–æ–≤–∏–∫ –ø–æ—Å–ª–µ–¥–Ω–µ–π –æ—Ç–ø—Ä–∞–≤–∫–∏. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å?')){
            Object.keys(draft).forEach(k => {
              const el = form.elements[k];
              if(!el) return;
              if(el.length && el[0] && el[0].type === 'checkbox'){
                // multiple checkboxes
                [...el].forEach(ch => ch.checked = (draft[k]||[]).includes(ch.value));
              } else if(el.type === 'checkbox'){
                el.checked = !!draft[k];
              } else {
                el.value = draft[k];
              }
            });
            draftInfo.textContent = '–ß–µ—Ä–Ω–æ–≤–∏–∫ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.';
          } else {
            draftInfo.textContent = '–ß–µ—Ä–Ω–æ–≤–∏–∫ –æ—Å—Ç–∞–≤–ª–µ–Ω –≤ localStorage.';
          }
        }
      } catch(e){
        // ignore JSON errors
        console.warn('restore draft failed', e);
      }

      // Save draft on input
      form.addEventListener('input', () => {
        const data = gatherData();
        try{ localStorage.setItem(FORM_KEY, JSON.stringify(data)); }
        catch(e){ /* ignore storage errors */ }
      });

      form.addEventListener('submit', async function(e){
        e.preventDefault();
        // simple constraint validation
        if(!form.checkValidity()){
          form.reportValidity();
          return;
        }

        const data = gatherData();

        // disable submit
        btn.disabled = true;
        const origText = btn.textContent;
        btn.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';
        statusEl.textContent = '';

        // Abort after timeout
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 10000);

        try{
          const res = await fetch(url, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            },
            body: JSON.stringify(data),
            signal: controller.signal
          });

          clearTimeout(timeout);

          if(!res.ok){
            const text = await safeText(res);
            throw new Error('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É: ' + res.status + ' ' + text);
          }

          // try parse response
          let json;
          try{ json = await res.json(); } catch(e){ json = null; }

          statusEl.textContent = '‚úÖ –û—Ç–≤–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ —Ç–∞–±–ª–∏—Ü–µ!';
          draftInfo.textContent = '';
          form.reset();
          try{ localStorage.removeItem(FORM_KEY); } catch(e){}

        } catch(err){
          // network or server error
          console.error(err);
          statusEl.textContent = '‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + (err.name === 'AbortError' ? '—Ç–∞–π–º–∞—É—Ç' : err.message);
          // keep draft and offer manual save
          try{ localStorage.setItem(FORM_KEY, JSON.stringify(data)); }
          catch(e){}
          draftInfo.innerHTML = '–ß–µ—Ä–Ω–æ–≤–∏–∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –ª–æ–∫–∞–ª—å–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑ –∏–ª–∏ –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.';
        } finally{
          btn.disabled = false;
          btn.textContent = origText;
        }
      });

      // gather form data into object
      function gatherData(){
        const formData = new FormData(form);
        const q5 = Array.from(form.querySelectorAll('input[name="q5"]:checked')).map(i=>i.value);
        return {
          fio: (formData.get('fio') || '').toString(),
          topic: (formData.get('topic') || '').toString(),
          q1: (formData.get('q1') || '').toString(),
          q2: (formData.get('q2') || '').toString(),
          q3: (formData.get('q3') || '').toString(),
          q4: (formData.get('q4') || '').toString(),
          q5: q5
        };
      }

      async function safeText(res){
        try{ return await res.text(); } catch(e){ return ''; }
      }

    })();
  </script>
</body>
</html>
